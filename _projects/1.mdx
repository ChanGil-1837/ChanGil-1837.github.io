# Unity Enviro 3 + Depth of Field 문제 해결 
![Image 1](/_projects/1/1.gif)
## 문제 상황
![Image 2](/_projects/1/5.png)

최근 Unity Asset Store에서 **Enviro 3 Sky and Weather**(하늘/날씨 시스템)을 구매했다.    
그런데 Depth of Field(Bokeh) 포스트 프로세스를 적용해보니, 원경(스카이박스와 구름)까지 뿌옇게 블러가 걸려 버렸다.    
즉, 건물 같은 3D 오브젝트는 괜찮지만, 내가 돈 주고 산 멋진 하늘이 포스트 프로세스 효과 때문에 흐려져 버린 것이다.  
![Image 2](/_projects/1/4.png)
개발자에게 문의해보니 해본적 없다고 한다...
하지만 이대로 포기할 순 없으니 한번 방법을 생각해보도록 하자.  
<br/>
---
<br/>

## 왜 이런 문제가 발생할까?


포스트 프로세스(Post-Process)는 렌더링이 끝난 화면의 **픽셀 전체**에 필터를 적용하는 방식이다.  


하지만 피사계 심도(DoF, Depth of Field)는 단순한 색 보정 필터가 아니다.


픽셀마다 **뎁스 버퍼(Depth Buffer)**를 참고해 얼마나 블러(blur)를 적용할지 계산한다.


즉, 렌더 타겟에 그려진 모든 픽셀(오브젝트 + 하늘)이 DoF 연산 대상이 된다.


문제는 하늘에도 보케가 적용된다는 점이다.  

뎁스 버퍼는 카메라 근처를 `0.0`, 멀리 있는 것을 `1.0`으로 표현한다.  

하늘은 사실상 **무한 원경**에 위치하기 때문에, 뎁스 값이 1.0에 가깝다.

따라서 Bokeh DoF 계산 과정에서 하늘 영역을 별도로 예외 처리하지 않으면, 하늘도 일반 오브젝트처럼 블러가 적용되는 문제가 발생한다.
<br/>
---
<br/>

## 해결 방법

해법은 간단하다.  

**DepthTexture에서 스카이박스 영역을 감지한 뒤, CoC(Circle of Confusion)를 0으로 고정해 블러를 제외**하면 된다.
<br/>
---
<br/>
### 원본 코드 (URP Bokeh Shader, `FragCoC`)

```hlsl
half FragCoC(Varyings input) : SV_Target
{
    UNITY_SETUP_STEREO_EYE_INDEX_POST_VERTEX(input);

    float2 uv = UnityStereoTransformScreenSpaceTex(input.texcoord);
    float depth = LOAD_TEXTURE2D_X(_CameraDepthTexture, _SourceSize.xy * uv).x;
    float linearEyeDepth = LinearEyeDepth(depth, _ZBufferParams);

    half coc = (1.0 - FocusDist / linearEyeDepth) * MaxCoC;
    half nearCoC = clamp(coc, -1.0, 0.0);
    half farCoC = saturate(coc);

    return saturate((farCoC + nearCoC + 1.0) * 0.5);
}
```

---

### 수정된 코드 (Skybox 제외 처리)

```hlsl
half FragCoC(Varyings input) : SV_Target
{
    UNITY_SETUP_STEREO_EYE_INDEX_POST_VERTEX(input);

    float2 uv = UnityStereoTransformScreenSpaceTex(input.texcoord);
    float depth = LOAD_TEXTURE2D_X(_CameraDepthTexture, _SourceSize.xy * uv).x; // Depth: 0.0 (near) ~ 1.0 (far)
    float linearEyeDepth = LinearEyeDepth(depth, _ZBufferParams);

    // Main CoC calculation
    half coc = (1.0 - FocusDist / linearEyeDepth) * MaxCoC;

    // --- Prevent DoF blur on skybox/clouds ---
    const float SKYBOX_DEPTH_THRESHOLD_NEAR_ZERO = 0.0001f;
    const float SKYBOX_DEPTH_THRESHOLD_FAR = 0.9999f;

    if (depth <= SKYBOX_DEPTH_THRESHOLD_NEAR_ZERO || depth >= SKYBOX_DEPTH_THRESHOLD_FAR)
    {
        coc = 0.0h;
    }
    // --- End of exclusion logic ---

    half nearCoC = clamp(coc, -1.0, 0.0);
    half farCoC = saturate(coc);

    return saturate((farCoC + nearCoC + 1.0) * 0.5);
}
```
<br/>
짧게 설명하자면,  

**원경에 해당하는 1 부분에 대해서는 계산에서 제외**하면 내 돈 주고 구매한 멋진 하늘이 보케가 씌워지지 않게 된다는 것이다.
<br/>
---
<br/>

## 결과
![Image 3](/_projects/1/1.gif)

![Image 4](/_projects/1/2.png)
**개발 중 화면**

자세히 보면 건물 및 배경에는 보케가 적용되어 부옇게 보이지만,  

**하늘의 별은 아름답게 빛나고 있다는 사실**을 알 수 있다.





<br/>
---
<br/>
## 결론

포스트 프로세스 효과는 화면 전체 픽셀에 무차별적으로 적용되므로, **깊이 기반 예외 처리**가 필수이다.  

이번 수정 덕분에, 구매한 80달러짜리 멋진 하늘이 더 이상 뿌옇지 않고, 아름답게 유지된다.

---

> _"내가 좋아하는 작가의 소설 속 한 문구와 함께 마무리하자."_

![Image 5](/_projects/1/3.jpg)
